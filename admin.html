<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial; background: #f0f0f0; padding: 20px; }
    h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { padding: 10px; border: 1px solid #ccc; }
    th { background: #333; color: white; }
    tr:nth-child(even) { background: #f9f9f9; }
  </style>
</head>

<body>

<h2>Admin Dashboard â€“ User Energy History</h2>

<table id="historyTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Username</th>
      <th>Email</th>
      <th>Location</th>
      <th>Model Used</th>
      <th>Total kWh</th>
      <th>Total Cost</th>
      <th>Timestamp</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// ------------------------------
// PROTECT ADMIN PAGE
// ------------------------------
fetch("/me")
  .then(res => res.json())
  .then(data => {
    if (!data.logged_in || data.role !== "admin") {
      window.location.href = "login.html";
    }
  });

// ------------------------------
// LOAD ALL USER HISTORY
// ------------------------------
async function loadHistory() {
  const res = await fetch('/admin/history',{
      credentials: "include"
    });
  const result = await res.json();

  if (result.status !== "ok") {
    alert("Failed to load admin data");
    return;
  }

  const data = result.data;
  const table = document.querySelector("#historyTable tbody");
  table.innerHTML = "";

  data.forEach(row => {
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td>${row.id}</td>
      <td>${row.username || "Unknown"}</td>
      <td>${row.email || "No Email"}</td>
      <td>${row.location || "Not Provided"}</td>
      <td>${row.model_used}</td>
      <td>${row.total_kwh}</td>
      <td>${row.total_cost}</td>
      <td>${row.timestamp}</td>
      <td><button onclick="deleteHistory(${row.id})">Delete</button></td>
    `;
    table.appendChild(tr);
  });
}

// ------------------------------
// DELETE HISTORY RECORD
// ------------------------------
async function deleteHistory(id) {
  if (!confirm("Are you sure you want to delete this entry?")) return;

  const res = await fetch(`/admin/delete-history/${id}`, {
    method: "DELETE",
     credentials: "include"
  });

  const data = await res.json();

  if (data.status === "ok") {
    alert("Deleted successfully!");
    loadHistory();  // refresh table
  } else {
    alert("Delete failed: " + data.message);
  }
}


// auto-load on page open
loadHistory();

</script>

</body>
</html>
