

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ML-Based Energy Consumption Predictor</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
/* ... (CSS remains the same) ... */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

.header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 30px;
  text-align: center;
}

.header h1 {
  font-size: 2.5rem;
  margin-bottom: 10px;
}

.header p {
  font-size: 1.1rem;
  opacity: 0.9;
}

.current-rate {
  text-align: center;
  margin: 20px 30px;
  font-size: 1.2rem;
  font-weight: 600;
  color: #333;
  padding: 15px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 10px;
}

.ml-section {
  padding: 30px;
}

.ml-section h2 {
  color: #333;
  margin-bottom: 20px;
  font-size: 1.8rem;
  text-align: center;
}

.ml-models-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 25px;
  margin-bottom: 30px;
}

.ml-model-card {
  background: white;
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  border-left: 5px solid;
  transition: all 0.3s ease;
}

.linear-regression { border-left-color: #28a745; }
.random-forest { border-left-color: #ffc107; }
.lstm { border-left-color: #dc3545; }

.model-header {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
}

.model-icon {
  font-size: 2.5rem;
  margin-right: 15px;
}

.model-title {
  font-size: 1.4rem;
  font-weight: 700;
  color: #333;
}

.model-subtitle {
  font-size: 0.95rem;
  color: #666;
  margin-top: 5px;
}

.model-description {
  color: #555;
  line-height: 1.6;
  margin-bottom: 20px;
}

.model-features {
  list-style: none;
  padding: 0;
  margin-bottom: 20px;
}

.model-features li {
  padding: 5px 0;
  color: #666;
  position: relative;
  padding-left: 20px;
}

.model-features li::before {
  content: '‚úì';
  position: absolute;
  left: 0;
  color: #28a745;
  font-weight: bold;
}

.model-status {
  margin-top: 20px;
  padding: 10px 15px;
  border-radius: 8px;
  font-weight: 600;
  text-align: center;
}

.status-training {
  background: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}

.status-ready {
  background: #d1ecf1;
  color: #0c5460;
  border: 1px solid #bee5eb;
}

.status-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f1b2b7;
}

.model-metrics {
  margin-top: 10px;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 6px;
  font-size: 0.9rem;
  display: none;
}

.btn {
  padding: 12px 25px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn.green { background: #28a745; }
.btn.red { background: #dc3545; }
.btn.small { padding: 8px 16px; font-size: 0.9rem; }

.button-row {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.appliance-section {
  padding: 30px;
}

.appliance-section h2 {
  color: #333;
  margin-bottom: 10px;
  font-size: 1.8rem;
  text-align: center;
}

.appliance-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.appliance-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
  border-left: 4px solid;
  transition: all 0.3s ease;
}

.appliance-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.appliance-header {
  display: flex;
  align-items: center;
  margin-bottom: 15px;
}

.appliance-icon {
  font-size: 2rem;
  margin-right: 15px;
}

.appliance-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: #333;
}

.appliance-power {
  font-size: 0.9rem;
  color: #666;
  margin-top: 2px;
}

.appliance-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.quantity-control {
  display: flex;
  align-items: center;
  gap: 10px;
}

.quantity-btn {
  width: 35px;
  height: 35px;
  border: none;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.quantity-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.quantity-display {
  font-size: 1.3rem;
  font-weight: bold;
  color: #333;
  min-width: 30px;
  text-align: center;
}

.usage-schedule {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.total-hours {
  font-size: 0.9rem;
  color: #666;
  font-weight: 500;
}

.estimated-cost {
  font-size: 0.9rem;
  color: #4CAF50;
  font-weight: 600;
}

.location-card {
  background: #e3f2fd;
  border-left-color: #2196F3;
}

.location-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  flex-wrap: wrap;
}

select {
  flex: 1;
  max-width: 300px;
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
  background: white;
}

.predict-btn {
  width: calc(100% - 60px);
  padding: 15px;
  margin: 20px 30px;
  font-size: 1.1rem;
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.predict-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 15px 30px rgba(40, 167, 69, 0.3);
}

.loading {
  display: none;
  text-align: center;
  padding: 30px;
  margin: 30px;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 5px solid rgba(102, 126, 234, 0.2);
  border-radius: 50%;
  border-top-color: #667eea;
  animation: spin 1s ease-in-out infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.results-section {
  background: white;
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
  margin: 30px;
}

.results-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.result-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  transition: all 0.3s ease;
}

.result-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
}

.result-icon {
  font-size: 2rem;
  margin-bottom: 10px;
}

.result-title {
  font-size: 1rem;
  opacity: 0.9;
  margin-bottom: 10px;
}

.result-value {
  font-size: 1.8rem;
  font-weight: bold;
}

.chart-section {
  margin-top: 30px;
}

.chart-section h3 {
  color: #333;
  margin-bottom: 20px;
  text-align: center;
}

.chart-container {
  height: 300px;
  margin-top: 20px;
  position: relative;
}

.breakdown-section {
  margin-top: 30px;
}

.breakdown-section h3 {
  color: #333;
  margin-bottom: 20px;
  text-align: center;
}

.breakdown-items {
  margin-top: 20px;
}

.breakdown-item {
  background: #f8f9fa;
  border-radius: 10px;
  padding: 15px;
  display: flex;
  align-items: center;
  gap: 15px;
  transition: all 0.3s ease;
  margin-bottom: 15px;
}

.breakdown-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
}

.breakdown-icon {
  font-size: 2rem;
  color: #667eea;
}

.breakdown-details {
  flex: 1;
}

.breakdown-name {
  font-weight: 600;
  color: #333;
  margin-bottom: 5px;
}

.breakdown-consumption {
  font-size: 0.9rem;
  color: #666;
}

.breakdown-percentage {
  font-size: 0.9rem;
  font-weight: 600;
  color: #333;
  background: #e9ecef;
  padding: 3px 8px;
  border-radius: 20px;
}

.status-message {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(255, 255, 255, 0.9);
  padding: 15px 25px;
  border-radius: 8px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  display: none;
  font-weight: 500;
  max-width: 80%;
  text-align: center;
}

.status-message.error {
  background-color: rgba(244, 67, 54, 0.1);
  color: #d32f2f;
  border-left: 4px solid #d32f2f;
}

.status-message.success {
  background-color: rgba(76, 175, 80, 0.1);
  color: #2e7d32;
  border-left: 4px solid #4caf50;
}

@media (max-width: 768px) {
  .header h1 { font-size: 2rem; }
  .appliance-grid { grid-template-columns: 1fr; }
  .ml-models-grid { grid-template-columns: 1fr; }
  .results-grid { grid-template-columns: 1fr; }
  .location-controls { flex-direction: column; }
  select { max-width: 100%; }
  .button-row { flex-direction: column; }
}

@media (max-width: 480px) {
  body { padding: 10px; }
  .appliance-controls { flex-direction: column; gap: 15px; }
  .predict-btn { width: calc(100% - 20px); margin: 20px 10px; }
}
/* DARK MODE STYLES */

body.dark-mode {
  background: #1f1f1f !important;
  color: #e6e6e6 !important;
}

.dark-mode input,
.dark-mode select,
.dark-mode button,
.dark-mode textarea {
  background: #2b2b2b !important;
  color: white !important;
  border: 1px solid #444 !important;
}

.dark-mode table {
  background: #2b2b2b !important;
  color: white !important;
}

.dark-mode td,
.dark-mode th {
  border-color: #555 !important;
}

.dark-mode .container,
.dark-mode .box,
.dark-mode .card {
  background: #2d2d2d !important;
  box-shadow: 0 0 10px rgba(255,255,255,0.05);
}

.dark-mode #darkModeToggle {
  background: #f1c40f !important;
  color: #1f1f1f !important;
}

</style>
</head>
<body>
    <button id="darkModeToggle" style="
    position: fixed;
    top: 15px;
    right: 15px;
    background: #333;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    z-index: 9999;
">
üåô Dark Mode
</button>

    <div id="app-section">

<div class="container">
    <div class="header">
        <h1>ML-Based Energy Consumption Predictor</h1>
        <p>Advanced machine learning algorithms for accurate energy consumption forecasting</p>
    </div>
    
    <div class="current-rate">
        <span>Current Electricity Rate: </span>
        <span id="rate-display">‚Çπ6.0/kWh</span>
    </div>
    
    <div class="ml-section">
        <h2>Machine Learning Models</h2>
        
        <div class="ml-models-grid">
            <div class="ml-model-card linear-regression">
                <div class="model-header">
                    <div class="model-icon">üìà</div>
                    <div>
                        <div class="model-title">Linear Regression</div>
                        <div class="model-subtitle">Statistical Baseline Model</div>
                    </div>
                </div>
                <div class="model-description">
                    Linear regression establishes relationships between appliance usage patterns and energy consumption using least squares optimization.
                </div>
                <ul class="model-features">
                    <li>Fast training and prediction</li>
                    <li>Interpretable coefficients</li>
                    <li>Handles linear relationships well</li>
                    <li>Low computational overhead</li>
                </ul>
                <div class="model-status" data-model="linear">Not trained</div>
                <div class="model-metrics" data-model="linear"></div>
                <div class="button-row">
                    <button class="btn" data-model="linear" data-action="train" onclick="trainModel('linear')">Train Model</button>
                    <button class="btn red small" data-model="linear" data-action="reset" onclick="resetModel('linear')" style="display:none;">Reset</button>
                    <button class="btn green small" data-model="linear" data-action="toggle" onclick="toggleModel('linear')">Selected</button>
                </div>
            </div>
            
            <div class="ml-model-card random-forest">
                <div class="model-header">
                    <div class="model-icon">üå≥</div>
                    <div>
                        <div class="model-title">Random Forest</div>
                        <div class="model-subtitle">Ensemble Tree-Based Model</div>
                    </div>
                </div>
                <div class="model-description">
                    Random Forest combines multiple decision trees to capture non-linear patterns and feature interactions in energy consumption data.
                </div>
                <ul class="model-features">
                    <li>Handles non-linear relationships</li>
                    <li>Feature importance ranking</li>
                    <li>Robust to outliers</li>
                    <li>Captures complex interactions</li>
                </ul>
                <div class="model-status" data-model="forest">Not trained</div>
                <div class="model-metrics" data-model="forest"></div>
                <div class="button-row">
                    <button class="btn" data-model="forest" data-action="train" onclick="trainModel('forest')">Train Model</button>
                    <button class="btn red small" data-model="forest" data-action="reset" onclick="resetModel('forest')" style="display:none;">Reset</button>
                    <button class="btn green small" data-model="forest" data-action="toggle" onclick="toggleModel('forest')">Selected</button>
                </div>
            </div>
            
            <div class="ml-model-card lstm">
                <div class="model-header">
                    <div class="model-icon">üß†</div>
                    <div>
                        <div class="model-title">LSTM Neural Network</div>
                        <div class="model-subtitle">Deep Learning Time Series Model</div>
                    </div>
                </div>
                <div class="model-description">
                    Long Short-Term Memory network captures temporal dependencies and seasonal patterns using advanced neural architecture.
                </div>
                <ul class="model-features">
                    <li>Captures temporal patterns</li>
                    <li>Learns seasonal cycles</li>
                    <li>Handles sequence dependencies</li>
                    <li>Advanced pattern recognition</li>
                </ul>
                <div class="model-status" data-model="lstm">Not trained</div>
                <div class="model-metrics" data-model="lstm"></div>
                <div class="button-row">
                    <button class="btn" data-model="lstm" data-action="train" onclick="trainModel('lstm')">Train Model</button>
                    <button class="btn red small" data-model="lstm" data-action="reset" onclick="resetModel('lstm')" style="display:none;">Reset</button>
                    <button class="btn green small" data-model="lstm" data-action="toggle" onclick="toggleModel('lstm')">Selected</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="appliance-section">
        <h2>Your Appliances</h2>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">Configure your appliances for ML-powered prediction</p>
        
        <div class="appliance-grid">
            <div class="appliance-card location-card">
                <div class="appliance-header">
                    <div class="appliance-icon">üèôÔ∏è</div>
                    <div>
                        <div class="appliance-title">Your Location</div>
                        <div class="appliance-power">Select for accurate pricing</div>
                    </div>
                </div>
                <div class="location-controls">
                    <select id="location-select" onchange="updateElectricityRate()">
                        <option value="chandigarh">Chandigarh (‚Çπ6.0/kWh)</option>
                        <option value="delhi">Delhi (‚Çπ5.5/kWh)</option>
                        <option value="mumbai">Mumbai (‚Çπ7.8/kWh)</option>
                        <option value="bangalore">Bangalore (‚Çπ6.2/kWh)</option>
                        <option value="chennai">Chennai (‚Çπ4.8/kWh)</option>
                        <option value="kolkata">Kolkata (‚Çπ6.5/kWh)</option>
                        <option value="hyderabad">Hyderabad (‚Çπ7.2/kWh)</option>
                        <option value="pune">Pune (‚Çπ7.8/kWh)</option>
                        <option value="gurgaon">Gurgaon (‚Çπ6.8/kWh)</option>
                        <option value="average">India Average (‚Çπ7.0/kWh)</option>
                    </select>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #FFC107;">
                <div class="appliance-header">
                    <div class="appliance-icon">üí°</div>
                    <div>
                        <div class="appliance-title">LED Bulbs</div>
                        <div class="appliance-power">9 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('bulbs', -1)">-</button>
                        <div class="quantity-display" id="bulbs-qty">4</div>
                        <button class="quantity-btn" onclick="changeQuantity('bulbs', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="bulbs-total">5 hours/day</div>
                        <div class="estimated-cost" id="bulbs-cost">‚Çπ1.08/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #2196F3;">
                <div class="appliance-header">
                    <div class="appliance-icon">üåÄ</div>
                    <div>
                        <div class="appliance-title">Ceiling Fans</div>
                        <div class="appliance-power">75 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('fans', -1)">-</button>
                        <div class="quantity-display" id="fans-qty">3</div>
                        <button class="quantity-btn" onclick="changeQuantity('fans', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="fans-total">14 hours/day</div>
                        <div class="estimated-cost" id="fans-cost">‚Çπ18.90/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #FF5722;">
                <div class="appliance-header">
                    <div class="appliance-icon">‚ùÑÔ∏è</div>
                    <div>
                        <div class="appliance-title">Air Conditioner</div>
                        <div class="appliance-power">1500 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('ac', -1)">-</button>
                        <div class="quantity-display" id="ac-qty">1</div>
                        <button class="quantity-btn" onclick="changeQuantity('ac', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="ac-total">7 hours/day</div>
                        <div class="estimated-cost" id="ac-cost">‚Çπ63.00/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #4CAF50;">
                <div class="appliance-header">
                    <div class="appliance-icon">üßä</div>
                    <div>
                        <div class="appliance-title">Refrigerator</div>
                        <div class="appliance-power">150 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('refrigerator', -1)">-</button>
                        <div class="quantity-display" id="refrigerator-qty">1</div>
                        <button class="quantity-btn" onclick="changeQuantity('refrigerator', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="refrigerator-total">24 hours/day</div>
                        <div class="estimated-cost" id="refrigerator-cost">‚Çπ21.60/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #9C27B0;">
                <div class="appliance-header">
                    <div class="appliance-icon">üì∫</div>
                    <div>
                        <div class="appliance-title">Television</div>
                        <div class="appliance-power">100 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('tv', -1)">-</button>
                        <div class="quantity-display" id="tv-qty">1</div>
                        <button class="quantity-btn" onclick="changeQuantity('tv', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="tv-total">6 hours/day</div>
                        <div class="estimated-cost" id="tv-cost">‚Çπ3.60/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #607D8B;">
                <div class="appliance-header">
                    <div class="appliance-icon">üß∫</div>
                    <div>
                        <div class="appliance-title">Washing Machine</div>
                        <div class="appliance-power">500 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('washer', -1)">-</button>
                        <div class="quantity-display" id="washer-qty">1</div>
                        <button class="quantity-btn" onclick="changeQuantity('washer', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="washer-total">1 hours/day</div>
                        <div class="estimated-cost" id="washer-cost">‚Çπ3.00/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #E91E63;">
                <div class="appliance-header">
                    <div class="appliance-icon">üî•</div>
                    <div>
                        <div class="appliance-title">Water Heater</div>
                        <div class="appliance-power">1500 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('heater', -1)">-</button>
                        <div class="quantity-display" id="heater-qty">1</div>
                        <button class="quantity-btn" onclick="changeQuantity('heater', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="heater-total">2 hours/day</div>
                        <div class="estimated-cost" id="heater-cost">‚Çπ18.00/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #FF9800;">
                <div class="appliance-header">
                    <div class="appliance-icon">üè†</div>
                    <div>
                        <div class="appliance-title">Kitchen Chimney</div>
                        <div class="appliance-power">200 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('chimney', -1)">-</button>
                        <div class="quantity-display" id="chimney-qty">1</div>
                        <button class="quantity-btn" onclick="changeQuantity('chimney', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="chimney-total">2 hours/day</div>
                        <div class="estimated-cost" id="chimney-cost">‚Çπ2.40/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #3F51B5;">
                <div class="appliance-header">
                    <div class="appliance-icon">üì±</div>
                    <div>
                        <div class="appliance-title">Microwave Oven</div>
                        <div class="appliance-power">800 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('microwave', -1)">-</button>
                        <div class="quantity-display" id="microwave-qty">1</div>
                        <button class="quantity-btn" onclick="changeQuantity('microwave', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="microwave-total">0.5 hours/day</div>
                        <div class="estimated-cost" id="microwave-cost">‚Çπ2.40/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #795548;">
                <div class="appliance-header">
                    <div class="appliance-icon">üíª</div>
                    <div>
                        <div class="appliance-title">Laptop/Computer</div>
                        <div class="appliance-power">65 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('laptop', -1)">-</button>
                        <div class="quantity-display" id="laptop-qty">1</div>
                        <button class="quantity-btn" onclick="changeQuantity('laptop', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="laptop-total">8 hours/day</div>
                        <div class="estimated-cost" id="laptop-cost">‚Çπ3.12/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #009688;">
                <div class="appliance-header">
                    <div class="appliance-icon">üëî</div>
                    <div>
                        <div class="appliance-title">Electric Iron</div>
                        <div class="appliance-power">1000 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('iron', -1)">-</button>
                        <div class="quantity-display" id="iron-qty">1</div>
                        <button class="quantity-btn" onclick="changeQuantity('iron', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="iron-total">0.5 hours/day</div>
                        <div class="estimated-cost" id="iron-cost">‚Çπ3.00/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #8BC34A;">
                <div class="appliance-header">
                    <div class="appliance-icon">üçΩÔ∏è</div>
                    <div>
                        <div class="appliance-title">Dishwasher</div>
                        <div class="appliance-power">1800 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('dishwasher', -1)">-</button>
                        <div class="quantity-display" id="dishwasher-qty">0</div>
                        <button class="quantity-btn" onclick="changeQuantity('dishwasher', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="dishwasher-total">1 hours/day</div>
                        <div class="estimated-cost" id="dishwasher-cost">‚Çπ0.00/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #00BCD4;">
                <div class="appliance-header">
                    <div class="appliance-icon">üí®</div>
                    <div>
                        <div class="appliance-title">Air Cooler</div>
                        <div class="appliance-power">200 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('cooler', -1)">-</button>
                        <div class="quantity-display" id="cooler-qty">1</div>
                        <button class="quantity-btn" onclick="changeQuantity('cooler', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="cooler-total">10 hours/day</div>
                        <div class="estimated-cost" id="cooler-cost">‚Çπ12.00/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #FF5722;">
                <div class="appliance-header">
                    <div class="appliance-icon">üîã</div>
                    <div>
                        <div class="appliance-title">Inverter/UPS</div>
                        <div class="appliance-power">50 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('inverter', -1)">-</button>
                        <div class="quantity-display" id="inverter-qty">1</div>
                        <button class="quantity-btn" onclick="changeQuantity('inverter', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="inverter-total">24 hours/day</div>
                        <div class="estimated-cost" id="inverter-cost">‚Çπ7.20/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #9E9E9E;">
                <div class="appliance-header">
                    <div class="appliance-icon">üì∂</div>
                    <div>
                        <div class="appliance-title">WiFi Router</div>
                        <div class="appliance-power">15 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('router', -1)">-</button>
                        <div class="quantity-display" id="router-qty">1</div>
                        <button class="quantity-btn" onclick="changeQuantity('router', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="router-total">24 hours/day</div>
                        <div class="estimated-cost" id="router-cost">‚Çπ2.16/day</div>
                    </div>
                </div>
            </div>
            
            <div class="appliance-card" style="border-left-color: #CDDC39;">
                <div class="appliance-header">
                    <div class="appliance-icon">ü•Ñ</div>
                    <div>
                        <div class="appliance-title">Mixer Grinder</div>
                        <div class="appliance-power">500 Watts</div>
                    </div>
                </div>
                <div class="appliance-controls">
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity('mixer', -1)">-</button>
                        <div class="quantity-display" id="mixer-qty">1</div>
                        <button class="quantity-btn" onclick="changeQuantity('mixer', 1)">+</button>
                    </div>
                    <div class="usage-schedule">
                        <div class="total-hours" id="mixer-total">0.3 hours/day</div>
                        <div class="estimated-cost" id="mixer-cost">‚Çπ0.90/day</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="save-section">
  <h3>üíæ Database Controls</h3>
  <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:8px">
    <button class="btn green" onclick="saveProfile()">üíæ Save Profile</button>
    <button class="btn" onclick="loadProfile()">üìÇ Load Profile</button>
    <button class="btn" id="view-history-btn" style="display:none;" onclick="viewHistory()">üìä View History</button>
    <button class="btn" style="background:#dc3545" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
  </div>
  <div id="db-status" style="margin-top:10px;color:#666;text-align:center"></div>
</div>


    <button class="predict-btn" onclick="calculateConsumption()">
        Calculate Energy Consumption with ML
    </button>

    <div id="status" class="status-message"></div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>Training models and calculating consumption...</div>
    </div>

    <div id="results" class="results-section" style="display: none;">
        <h2>ML Prediction Results</h2>
        
        <div class="results-grid">
            <div class="result-card">
                <div class="result-icon">‚ö°</div>
                <div class="result-title">Daily Consumption</div>
                <div class="result-value" id="daily-consumption">0 kWh</div>
            </div>
            
            <div class="result-card">
                <div class="result-icon">üìÖ</div>
                <div class="result-title">Monthly Consumption</div>
                <div class="result-value" id="monthly-consumption">0 kWh</div>
            </div>
            
            <div class="result-card">
                <div class="result-icon">üí∞</div>
                <div class="result-title">Monthly Cost</div>
                <div class="result-value" id="monthly-cost">‚Çπ0</div>
            </div>
            
            <div class="result-card">
                <div class="result-icon">üéØ</div>
                <div class="result-title">Best Model</div>
                <div class="result-value" id="best-model">Linear Regression</div>
            </div>
        </div>
        
        <div class="chart-section">
            <h3>Consumption Breakdown</h3>
            <div class="chart-container">
                <canvas id="consumption-chart"></canvas>
            </div>
        </div>
        
        <div class="breakdown-section">
            <h3>Detailed Breakdown</h3>
            <div class="breakdown-items" id="breakdown-items"></div>
        </div>
        
        <div class="breakdown-section">
            <h3>üåç Carbon Footprint Analysis</h3>
            <div class="results-grid">
                <div class="result-card" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);">
                    <div class="result-icon">üè≠</div>
                    <div class="result-title">Monthly CO‚ÇÇ Emissions</div>
                    <div class="result-value" id="carbon-emissions">0 kg</div>
                </div>
                
                <div class="result-card" style="background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);">
                    <div class="result-icon">üå≥</div>
                    <div class="result-title">Trees Needed to Offset</div>
                    <div class="result-value" id="trees-needed">0 trees</div>
                </div>
                
                <div class="result-card" style="background: linear-gradient(135deg, #45B7D1 0%, #96C93D 100%);">
                    <div class="result-icon">üåç</div>
                    <div class="result-title">Environmental Impact</div>
                    <div class="result-value" id="impact-level">Low</div>
                </div>
            </div>
        </div>
        
        <div class="breakdown-section">
            <h3>üí° Energy Saving Recommendations</h3>
            <div id="energy-tips" class="breakdown-items"></div>
        </div>
    </div>
</div>

<script>
// Define the server URL globally, as the browser cannot resolve relative paths like '/me' in non-standard environments.
const SERVER_URL = 'http://localhost:3001';

// Application state
const appliances = {
    'bulbs': { power: 9, hours: 5 },
  'fans': { power: 75, hours: 14 },
  'ac': { power: 1500, hours: 7 },
  'refrigerator': { power: 150, hours: 24 },
  'tv': { power: 100, hours: 6 },
  'washer': { power: 500, hours: 1 },
  'heater': { power: 1500, hours: 2 },
  'chimney': { power: 200, hours: 2 },
  'microwave': { power: 800, hours: 0.5 },
  'laptop': { power: 65, hours: 8 },
  'iron': { power: 1000, hours: 0.5 },
  'dishwasher': { power: 1800, hours: 1 },
  'cooler': { power: 200, hours: 10 },
  'inverter': { power: 50, hours: 24 },
  'router': { power: 15, hours: 24 },
  'mixer': { power: 500, hours: 0.3 }
};

const stateRates = {
    'chandigarh': { name: 'Chandigarh', rate: 6.0 },
    'delhi': { name: 'Delhi', rate: 5.5 },
    'mumbai': { name: 'Mumbai', rate: 7.8 },
    'bangalore': { name: 'Bangalore', rate: 6.2 },
    'chennai': { name: 'Chennai', rate: 4.8 },
    'kolkata': { name: 'Kolkata', rate: 6.5 },
    'hyderabad': { name: 'Hyderabad', rate: 7.2 },
    'pune': { name: 'Pune', rate: 7.8 },
    'gurgaon': { name: 'Gurgaon', rate: 6.8 },
    'average': { name: 'India Average', rate: 7.0 }
};

let currentElectricityRate = 6.0;
let consumptionChart = null;

// ML Models state
const trainedModels = {
    linear: null,
    forest: null,
    lstm: null
};

const modelPerformance = {
    linear: { mse: null, r2: null },
    forest: { mse: null, r2: null },
    lstm: { mse: null, r2: null }
};

const selectedModels = {
    linear: true,
    forest: true,
    lstm: true
};

// Helper functions for DOM manipulation
function getStatusElement(model) {
    return document.querySelector(`[data-model="${model}"].model-status`);
}

function getMetricsElement(model) {
    return document.querySelector(`[data-model="${model}"].model-metrics`);
}

function getTrainButton(model) {
    return document.querySelector(`[data-model="${model}"][data-action="train"]`);
}

function getResetButton(model) {
    return document.querySelector(`[data-model="${model}"][data-action="reset"]`);
}

function getToggleButton(model) {
    return document.querySelector(`[data-model="${model}"][data-action="toggle"]`);
}

// Generate synthetic training data
function generateTrainingData(samples = 1000) {
    const data = [];
    const labels = [];
    
    for (let i = 0; i < samples; i++) {
        const sample = [];
        let totalConsumption = 0;
        
        for (const [appliance, config] of Object.entries(appliances)) {
            const quantity = Math.floor(Math.random() * 4) + 1;
            const hours = Math.max(1, config.hours + Math.floor(Math.random() * 6) - 3);
            const consumption = (quantity * config.power * hours) / 1000;
            
            sample.push(quantity, hours);
            totalConsumption += consumption;
        }
        
        const seasonalFactor = 1 + 0.3 * Math.sin((i / samples) * 2 * Math.PI);
        totalConsumption *= seasonalFactor;
        totalConsumption += (Math.random() - 0.5) * 2;
        
        data.push(sample);
        labels.push(Math.max(0, totalConsumption));
    }
    
    return { data, labels };
}

// Simple Linear Regression
class SimpleLinearRegression {
    constructor() {
        this.weights = null;
        this.bias = 0;
    }
    
    async train(X, y) {
        const n = X.length;
        const features = X[0].length;
        this.weights = new Array(features).fill(0);
        
        const learningRate = 0.001;
        const epochs = 1000;
        
        for (let epoch = 0; epoch < epochs; epoch++) {
            for (let i = 0; i < n; i++) {
                const prediction = this.predict([X[i]])[0];
                const error = y[i] - prediction;
                
                for (let j = 0; j < features; j++) {
                    // Simple update rule (Gradient Descent approximation)
                    this.weights[j] += learningRate * error * X[i][j];
                }
                this.bias += learningRate * error;
            }
        }
    }
    
    predict(X) {
        return X.map(sample => {
            let sum = this.bias;
            for (let i = 0; i < sample.length; i++) {
                sum += (this.weights[i] || 0) * sample[i];
            }
            return Math.max(0, sum);
        });
    }
}

// Simple Random Forest (using multiple Linear Regressions)
class SimpleRandomForest {
    constructor(numTrees = 10) {
        this.numTrees = numTrees;
        this.trees = [];
    }
    
    async train(X, y) {
        this.trees = [];
        
        for (let t = 0; t < this.numTrees; t++) {
            const bootstrap = this.bootstrap(X, y);
            const tree = new SimpleLinearRegression();
            await tree.train(bootstrap.X, bootstrap.y);
            this.trees.push(tree);
        }
    }
    
    bootstrap(X, y) {
        const n = X.length;
        const bootstrapX = [];
        const bootstrapY = [];
        
        for (let i = 0; i < n; i++) {
            const idx = Math.floor(Math.random() * n);
            bootstrapX.push(X[idx]);
            bootstrapY.push(y[idx]);
        }
        
        return { X: bootstrapX, y: bootstrapY };
    }
    
    predict(X) {
        const predictions = this.trees.map(tree => tree.predict(X));
        
        return X.map((_, i) => {
            const sum = predictions.reduce((acc, pred) => acc + (pred[i] || 0), 0);
            return sum / this.trees.length;
        });
    }
}

// Calculate model performance metrics
function calculateMetrics(actual, predicted) {
    const n = actual.length;
    
    if (n === 0) return { mse: 'N/A', r2: 'N/A' };

    const mse = actual.reduce((sum, val, i) => sum + Math.pow(val - (predicted[i] || 0), 2), 0) / n;
    
    const meanActual = actual.reduce((sum, val) => sum + val, 0) / n;
    const totalSumSquares = actual.reduce((sum, val) => sum + Math.pow(val - meanActual, 2), 0);
    const residualSumSquares = actual.reduce((sum, val, i) => sum + Math.pow(val - (predicted[i] || 0), 2), 0);
    
    let r2 = 0;
    if (totalSumSquares !== 0) {
        r2 = 1 - (residualSumSquares / totalSumSquares);
    }
    
    return { mse: mse.toFixed(4), r2: Math.max(0, r2).toFixed(4) };
}

// Train model function
async function trainModel(modelType) {
    const statusEl = getStatusElement(modelType);
    const metricsEl = getMetricsElement(modelType);
    const trainBtn = getTrainButton(modelType);
    const resetBtn = getResetButton(modelType);
    
    if (!statusEl || !trainBtn) {
        console.error('Required elements not found for model:', modelType);
        return;
    }
    
    trainBtn.disabled = true;
    statusEl.className = 'model-status status-training';
    statusEl.textContent = 'Training...';
    
    try {
        const trainingData = generateTrainingData();
        let model;
        let metrics;
        
        if (modelType === 'linear') {
            model = new SimpleLinearRegression();
            await model.train(trainingData.data, trainingData.labels);
            metrics = calculateMetrics(trainingData.labels, model.predict(trainingData.data));
            
        } else if (modelType === 'forest') {
            model = new SimpleRandomForest(5);
            await model.train(trainingData.data, trainingData.labels);
            metrics = calculateMetrics(trainingData.labels, model.predict(trainingData.data));
            
        } else if (modelType === 'lstm') {
            if (typeof tf === 'undefined') {
                throw new Error('TensorFlow.js not loaded. Cannot train LSTM.');
            }
            
            // Convert data to Tensors
            const inputShape = trainingData.data[0].length;
            const xs = tf.tensor2d(trainingData.data, [trainingData.data.length, inputShape]);
            const ys = tf.tensor2d(trainingData.labels, [trainingData.labels.length, 1]);
            
            model = tf.sequential({
                layers: [
                    tf.layers.dense({ inputShape: [inputShape], units: 32, activation: 'relu' }),
                    tf.layers.dropout({ rate: 0.2 }),
                    tf.layers.dense({ units: 16, activation: 'relu' }),
                    tf.layers.dense({ units: 1, activation: 'linear' })
                ]
            });
            
            model.compile({
                optimizer: 'adam',
                loss: 'meanSquaredError',
                metrics: ['mae']
            });
            
            // Train the model
            await model.fit(xs, ys, {
                epochs: 50,
                batchSize: 32,
                verbose: 0,
            });
            
            // Calculate metrics (using the training data for simplicity in this demo)
            const testPredictions = model.predict(xs).arraySync().flat();
            metrics = calculateMetrics(trainingData.labels, testPredictions);
            
            // Clean up training tensors
            xs.dispose();
            ys.dispose();
        }
        
        trainedModels[modelType] = model;
        modelPerformance[modelType] = metrics;
        
        statusEl.className = 'model-status status-ready';
        statusEl.textContent = 'Ready';
        
        if (metricsEl) {
            metricsEl.style.display = 'block';
            metricsEl.innerHTML = `MSE: ${metrics.mse} | R¬≤: ${metrics.r2}`;
        }
        
        trainBtn.textContent = 'Retrain Model';
        if (resetBtn) resetBtn.style.display = 'block';
        
        showStatus(`${getModelDisplayName(modelType)} trained successfully! R¬≤: ${metrics.r2}`, false);
        
    } catch (error) {
        console.error('Training error for ' + modelType + ':', error);
        statusEl.className = 'model-status status-error';
        statusEl.textContent = 'Training failed';
        
        if (metricsEl) metricsEl.style.display = 'none';

        if (modelType === 'lstm') {
             showStatus(`LSTM training failed. Error: ${error.message}. Ensure TensorFlow is loaded and accessible.`, true);
        } else {
             showStatus(`Failed to train ${getModelDisplayName(modelType)}. Check console for details.`, true);
        }

    } finally {
        trainBtn.disabled = false;
        // Ensure to dispose of any TensorFlow models if they failed to train completely
        if (modelType === 'lstm' && trainedModels[modelType] && trainedModels[modelType].dispose) {
             // If training fails, the model might not be in trainedModels yet, so no need to dispose here.
        }
    }
}

// Reset model function
function resetModel(modelType) {
    if (confirm(`Are you sure you want to reset the ${getModelDisplayName(modelType)} model?`)) {
        if (modelType === 'lstm' && trainedModels[modelType] && trainedModels[modelType].dispose) {
            try {
                trainedModels[modelType].dispose();
                console.log(`LSTM model disposed.`);
            } catch (error) {
                console.warn('Error disposing LSTM model:', error);
            }
        }

        trainedModels[modelType] = null;
        modelPerformance[modelType] = { mse: null, r2: null };
        
        const statusEl = getStatusElement(modelType);
        const metricsEl = getMetricsElement(modelType);
        const trainBtn = getTrainButton(modelType);
        const resetBtn = getResetButton(modelType);
        
        if (statusEl) {
            statusEl.className = 'model-status';
            statusEl.textContent = 'Not trained';
        }
        
        if (metricsEl) {
            metricsEl.style.display = 'none';
            metricsEl.innerHTML = '';
        }
        
        if (trainBtn) {
            trainBtn.disabled = false;
            trainBtn.textContent = 'Train Model';
        }
        
        if (resetBtn) {
            resetBtn.style.display = 'none';
        }
        
        showStatus(`${getModelDisplayName(modelType)} model reset successfully!`, false);
    }
}

// Toggle model selection
function toggleModel(modelType) {
    selectedModels[modelType] = !selectedModels[modelType];
    const toggleBtn = getToggleButton(modelType);
    
    if (!toggleBtn) return;
    
    if (selectedModels[modelType]) {
        toggleBtn.className = 'btn green small';
        toggleBtn.textContent = 'Selected';
    } else {
        toggleBtn.className = 'btn red small';
        toggleBtn.textContent = 'Unselected';
    }
    
    const anySelected = Object.values(selectedModels).some(selected => selected);
    if (!anySelected) {
        showStatus('At least one model must be selected!', true);
        selectedModels[modelType] = true;
        toggleBtn.className = 'btn green small';
        toggleBtn.textContent = 'Selected';
    } else {
        showStatus(`${getModelDisplayName(modelType)} ${selectedModels[modelType] ? 'selected' : 'unselected'}`, false);
    }
}

// Get model display name
function getModelDisplayName(modelType) {
    const names = {
        'linear': 'Linear Regression',
        'forest': 'Random Forest',
        'lstm': 'LSTM Network'
    };
    return names[modelType] || modelType;
}

// Update electricity rate
function updateElectricityRate() {
    const locationSelect = document.getElementById('location-select');
    const selectedLocation = locationSelect.value;
    
    if (stateRates[selectedLocation]) {
        const locationData = stateRates[selectedLocation];
        currentElectricityRate = locationData.rate;
        
        document.getElementById('rate-display').textContent = `‚Çπ${currentElectricityRate}/kWh`;
        updateAllCosts();
        showStatus(`Rate updated to ‚Çπ${currentElectricityRate}/kWh for ${locationData.name}`, false);
    }
}

// Change appliance quantity
function changeQuantity(appliance, change) {
    const qtyElement = document.getElementById(appliance + '-qty');
    let currentQty = parseInt(qtyElement.textContent);
    
    currentQty += change;
    if (currentQty < 0) currentQty = 0;
    
    qtyElement.textContent = currentQty;
    updateApplianceCost(appliance);
}

// Update individual appliance cost
function updateApplianceCost(appliance) {
    const qtyElement = document.getElementById(`${appliance}-qty`);
    if (!qtyElement) {
        console.error(`Quantity element not found for appliance: ${appliance}`);
        return;
    }
    
    const quantity = parseInt(qtyElement.textContent);
    const config = appliances[appliance];
    
    if (!config) {
        console.error(`Config not found for appliance: ${appliance}`);
        return;
    }
    
    const dailyConsumption = (quantity * config.power * config.hours) / 1000;
    const dailyCost = dailyConsumption * currentElectricityRate;
    
    const totalElement = document.getElementById(`${appliance}-total`);
    const costElement = document.getElementById(`${appliance}-cost`);
    
    if (totalElement) totalElement.textContent = `${config.hours} hours/day`;
    if (costElement) costElement.textContent = `‚Çπ${dailyCost.toFixed(2)}/day`;
}

// Update all appliance costs
function updateAllCosts() {
    for (const appliance of Object.keys(appliances)) {
        updateApplianceCost(appliance);
    }
}

// Calculate consumption using ML models
async function calculateConsumption() {
    document.getElementById('results').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    
    let mlPrediction = 0;
    let totalDailyConsumption = 0;
    let bestModel = 'Baseline Calculation';
    let breakdown = {};
    const inputData = [];

    // --- 1. Calculate Baseline Consumption and prepare input data ---
    try {
        for (const [appliance, config] of Object.entries(appliances)) {
            const quantity = parseInt(document.getElementById(`${appliance}-qty`).textContent);
            const hours = config.hours;
            
            inputData.push(quantity, hours);
            
            const dailyConsumption = (quantity * config.power * config.hours) / 1000;
            totalDailyConsumption += dailyConsumption;
            
            if (quantity > 0) {
                breakdown[appliance] = {
                    quantity,
                    hours,
                    consumption: dailyConsumption,
                    percentage: 0
                };
            }
        }
        mlPrediction = totalDailyConsumption; // Start prediction with baseline
        
        for (const [appliance, data] of Object.entries(breakdown)) {
            data.percentage = totalDailyConsumption > 0 ? (data.consumption / totalDailyConsumption) * 100 : 0;
        }

    } catch (error) {
        console.error("Error during baseline calculation:", error);
        showStatus('Error reading appliance configuration. Using zero baseline.', true);
        document.getElementById('loading').style.display = 'none';
        return;
    }

    // --- 2. Run ML Predictions ---
    try {
        const predictions = {};
        
        // --- Linear Regression ---
        if (selectedModels.linear && trainedModels.linear) {
            predictions.linear = trainedModels.linear.predict([inputData])[0];
        }
        
        // --- Random Forest ---
        if (selectedModels.forest && trainedModels.forest) {
            predictions.forest = trainedModels.forest.predict([inputData])[0];
        }
        
        // --- LSTM Neural Network (Requires TensorFlow) ---
        if (selectedModels.lstm && trainedModels.lstm && typeof tf !== 'undefined') {
            const inputTensor = tf.tensor2d([inputData]);
            const prediction = await trainedModels.lstm.predict(inputTensor).data();
            predictions.lstm = prediction[0];
            inputTensor.dispose();
        }
        
        let bestScore = -1;
        
        for (const [modelType, performance] of Object.entries(modelPerformance)) {
            if (selectedModels[modelType] && performance.r2 && parseFloat(performance.r2) > bestScore && predictions[modelType]) {
                bestScore = parseFloat(performance.r2);
                mlPrediction = predictions[modelType];
                bestModel = getModelDisplayName(modelType);
            }
        }
        
        // Ensemble average if no single model is clearly best (or if no metrics)
        if (bestScore === -1 && Object.keys(predictions).length > 0) {
            const validPredictions = Object.values(predictions).filter(p => p && !isNaN(p));
            if (validPredictions.length > 0) {
                mlPrediction = validPredictions.reduce((sum, pred) => sum + pred, 0) / validPredictions.length;
                bestModel = `Ensemble Average`;
            }
        }
        
        // Fallback to baseline if ML prediction is invalid/zero after processing
        if (mlPrediction <= 0 || isNaN(mlPrediction)) {
            mlPrediction = totalDailyConsumption;
            bestModel = 'Baseline Calculation (ML Failed)';
            showStatus('ML prediction invalid or failed. Reverting to baseline consumption.', true);
        } else {
             mlPrediction = Math.max(0, mlPrediction); // Ensure consumption is not negative
        }

    } catch (error) {
        console.error('Prediction error, reverting to baseline:', error);
        mlPrediction = totalDailyConsumption;
        bestModel = 'Baseline Calculation (ML Error)';
        showStatus('ML prediction failed due to error. Reverting to baseline calculation.', true);
    }
    
    // --- 3. Final Calculation and Display ---
    const monthlyConsumption = mlPrediction * 30; // 30-day fixed month
    const monthlyCost = monthlyConsumption * currentElectricityRate;
    
    setTimeout(async () => {
        document.getElementById('daily-consumption').textContent = `${mlPrediction.toFixed(2)} kWh`;
        document.getElementById('monthly-consumption').textContent = `${monthlyConsumption.toFixed(2)} kWh`;
        document.getElementById('monthly-cost').textContent = `‚Çπ${monthlyCost.toFixed(2)}`;
        document.getElementById('best-model').textContent = bestModel;
        
        // Prepare data for backend save
        const appliancesData = {};
        for (const [appliance, data] of Object.entries(breakdown)) {
            appliancesData[appliance] = { 
                qty: data.quantity, 
                hours: data.hours,
                consumption: data.consumption.toFixed(2) 
            };
        }

        const historyEntry = {
          appliances: appliancesData,
          totalKwh: mlPrediction,
          totalCost: monthlyCost,
          modelUsed: bestModel,
          location: document.getElementById('location-select').value,
          rate: currentElectricityRate
        };
        
        await saveToHistory(historyEntry); // Save result to history (backend + local storage)

        updateCarbonFootprint(monthlyConsumption);
        generateEnergySavingTips(breakdown, mlPrediction);
        updateBreakdown(breakdown);
        updateConsumptionChart(breakdown);
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('results').style.display = 'block';
        document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        showStatus('Calculation complete! Results updated.', false);

    }, 1500);
}

// Update consumption chart
function updateConsumptionChart(breakdown) {
    const ctx = document.getElementById('consumption-chart').getContext('2d');
    
    if (consumptionChart) {
        consumptionChart.destroy();
    }
    
    const labels = [];
    const data = [];
    const colors = [];
    const colorMap = {
        'bulbs': '#FFC107',
        'fans': '#2196F3',
        'ac': '#FF5722',
        'refrigerator': '#4CAF50',
        'tv': '#9C27B0',
        'washer': '#607D8B',
        'heater': '#E91E63',
        'chimney': '#FF9800',
        'microwave': '#3F51B5',
        'laptop': '#795548',
        'iron': '#009688',
        'dishwasher': '#8BC34A',
        'cooler': '#00BCD4',
        'inverter': '#FF5722',
        'router': '#9E9E9E',
        'mixer': '#CDDC39'
    };
    
    for (const [appliance, applianceBreakdown] of Object.entries(breakdown)) {
        labels.push(getApplianceName(appliance));
        data.push(applianceBreakdown.consumption.toFixed(2));
        colors.push(colorMap[appliance] || '#999');
    }
    
    consumptionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderColor: 'rgba(255, 255, 255, 0.5)',
                borderWidth: 2,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        font: { size: 12 },
                        color: '#333',
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => parseFloat(a) + parseFloat(b), 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return ` ${context.label}: ${context.parsed} kWh (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '60%'
        }
    });
}

// Update breakdown section
function updateBreakdown(breakdown) {
    const container = document.getElementById('breakdown-items');
    container.innerHTML = '';
    
    const sortedBreakdown = Object.entries(breakdown)
        .sort((a, b) => b[1].consumption - a[1].consumption);
    
    for (const [appliance, applianceBreakdown] of sortedBreakdown) {
        const breakdownItem = document.createElement('div');
        breakdownItem.className = 'breakdown-item';
        
        breakdownItem.innerHTML = `
            <div class="breakdown-icon">${getApplianceIcon(appliance)}</div>
            <div class="breakdown-details">
                <div class="breakdown-name">${getApplianceName(appliance)} (${applianceBreakdown.quantity})</div>
                <div class="breakdown-consumption">${applianceBreakdown.consumption.toFixed(2)} kWh/day (${applianceBreakdown.hours} hours)</div>
            </div>
            <div class="breakdown-percentage">${applianceBreakdown.percentage.toFixed(1)}%</div>
        `;
        
        container.appendChild(breakdownItem);
    }
}

// Update carbon footprint information
function updateCarbonFootprint(monthlyConsumption) {
    const co2PerKwh = 0.82;
    const co2Emissions = monthlyConsumption * co2PerKwh;
    const treesNeeded = Math.ceil(co2Emissions / 1.83);
    
    let impactLevel = 'Low';
    if (co2Emissions > 500) impactLevel = 'Very High';
    else if (co2Emissions > 300) impactLevel = 'High';
    else if (co2Emissions > 150) impactLevel = 'Medium';
    
    const carbonEl = document.getElementById('carbon-emissions');
    const treesEl = document.getElementById('trees-needed');
    const impactEl = document.getElementById('impact-level');
    
    if (carbonEl) carbonEl.textContent = `${co2Emissions.toFixed(1)} kg`;
    if (treesEl) treesEl.textContent = `${treesNeeded}`;
    if (impactEl) impactEl.textContent = impactLevel;
}

// Generate energy saving tips
function generateEnergySavingTips(breakdown, dailyConsumption) {
    const tipsContainer = document.getElementById('energy-tips');
    tipsContainer.innerHTML = '';
    
    const sortedAppliances = Object.entries(breakdown)
        .sort((a, b) => b[1].consumption - a[1].consumption);
    
    const tips = [];
    
    if (dailyConsumption > 25) {
        tips.push({
            icon: 'üö®',
            title: 'Critical: High Energy Consumption Alert',
            description: 'Your daily consumption exceeds 25 kWh. Immediate energy-saving measures recommended to reduce environmental impact and costs.',
            savings: 'Priority: Reduce by 30-40% for significant impact',
            priority: 'critical'
        });
    }
    
    for (const [appliance, data] of sortedAppliances.slice(0, 4)) {
        if (data.consumption > 0.5) {
            const tip = getDetailedApplianceTips(appliance, data);
            if (tip) tips.push(tip);
        }
    }
    
    tips.push({
        icon: 'üí°',
        title: 'LED Lighting Upgrade',
        description: 'Switch to LED bulbs to save up to 80% energy. LEDs last 25x longer than incandescent bulbs and produce less heat.',
        savings: 'Potential savings: ‚Çπ50-150/month',
        priority: 'high'
    });
    
    tips.push({
        icon: 'üîå',
        title: 'Eliminate Phantom Loads',
        description: 'Unplug electronics when not in use. TVs, computers, and chargers consume power even when turned off.',
        savings: 'Potential savings: ‚Çπ30-80/month',
        priority: 'medium'
    });
    
    if (dailyConsumption > 15) {
        tips.push({
            icon: '‚òÄÔ∏è',
            title: 'Solar Panel System Installation',
            description: 'Your consumption pattern makes you an ideal candidate for solar panels. 3-5 kW system recommended.',
            savings: 'Potential savings: 60-80% of electricity bill',
            priority: 'high'
        });
    }
    
    tips.push({
        icon: '‚è∞',
        title: 'Peak Hour Usage Optimization',
        description: 'Shift high-power appliances (washing machine, dishwasher) to off-peak hours (11 PM - 6 AM).',
        savings: 'Potential savings: 10-25% on variable rate plans',
        priority: 'medium'
    });
    
    tips.push({
        icon: 'üå±',
        title: 'Carbon Footprint Reduction',
        description: 'Your electricity usage contributes to CO‚ÇÇ emissions. Every 1 kWh saved prevents 0.82 kg of CO‚ÇÇ emissions.',
        savings: 'Environmental: Reduce carbon footprint significantly',
        priority: 'environmental'
    });
    
    tips.forEach(tip => {
        const tipElement = document.createElement('div');
        tipElement.className = 'breakdown-item';
        
        let borderColor = '#4CAF50';
        if (tip.priority === 'critical') borderColor = '#F44336';
        else if (tip.priority === 'high') borderColor = '#FF9800';
        else if (tip.priority === 'environmental') borderColor = '#2196F3';
        
        tipElement.style.borderLeft = `4px solid ${borderColor}`;
        tipElement.innerHTML = `
            <div class="breakdown-icon">${tip.icon}</div>
            <div class="breakdown-details">
                <div class="breakdown-name">${tip.title}</div>
                <div class="breakdown-consumption">${tip.description}</div>
                <div style="color: ${borderColor}; font-weight: 600; margin-top: 5px;">${tip.savings}</div>
            </div>
        `;
        tipsContainer.appendChild(tipElement);
    });
    
    const totalSavings = Math.round(dailyConsumption * 30 * currentElectricityRate * 0.25);
    const co2Reduction = (dailyConsumption * 30 * 0.82 * 0.25).toFixed(1);
    
    const summaryElement = document.createElement('div');
    summaryElement.style.cssText = `
        background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
        border: 1px solid #c8e6c9;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        color: #2E7D32;
    `;
    summaryElement.innerHTML = `
        <h4 style="margin-bottom: 10px; color: #1B5E20;">üí∞ Combined Impact of Energy Saving Measures</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
                <strong>Monthly Bill Reduction:</strong><br>
                ‚Çπ${totalSavings} (up to 25% savings)
            </div>
            <div>
                <strong>CO‚ÇÇ Emissions Avoided:</strong><br>
                ${co2Reduction} kg CO‚ÇÇ per month
            </div>
        </div>
        <p style="font-size: 0.9rem; opacity: 0.8;">
            <strong>Environmental Benefit:</strong> Implementing these measures is equivalent to planting ${Math.ceil(co2Reduction / 1.83)} trees or removing a car from the road for ${Math.ceil(co2Reduction / 21)} days per month.
        </p>
    `;
    tipsContainer.appendChild(summaryElement);
}

function getDetailedApplianceTips(appliance, data) {
    const detailedTips = {
        'ac': {
            icon: '‚ùÑÔ∏è',
            title: 'Air Conditioner Optimization',
            description: 'Set temperature to 24-26¬∞C. Clean filters monthly. Use ceiling fans to distribute cool air. Consider inverter AC for 40% energy savings.',
            savings: 'Potential savings: ‚Çπ200-500/month',
            priority: 'high'
        },
        'heater': {
            icon: 'üî•',
            title: 'Water Heater Efficiency',
            description: 'Insulate tank and pipes. Set temperature to 50-60¬∞C. Consider solar water heating system for 70% energy reduction.',
            savings: 'Potential savings: ‚Çπ150-300/month',
            priority: 'high'
        },
        'refrigerator': {
            icon: 'üßä',
            title: 'Refrigerator Optimization',
            description: 'Maintain 3-5¬∞C temperature. Check door seals. Keep 15cm clearance around unit. Defrost regularly.',
            savings: 'Potential savings: ‚Çπ50-150/month',
            priority: 'medium'
        },
        'washer': {
            icon: 'üß∫',
            title: 'Washing Machine Efficiency',
            description: 'Use cold water (saves 90% of energy). Run full loads only. Clean lint filters. Use eco/quick wash modes.',
            savings: 'Potential savings: ‚Çπ40-120/month',
            priority: 'medium'
        },
        'tv': {
            icon: 'üì∫',
            title: 'Entertainment System Efficiency',
            description: 'Reduce screen brightness. Use power-saving modes. Turn off completely instead of standby mode.',
            savings: 'Potential savings: ‚Çπ20-60/month',
            priority: 'low'
        },
        'chimney': {
            icon: 'üè†',
            title: 'Kitchen Chimney Optimization',
            description: 'Clean grease filters monthly. Use appropriate speed settings. Switch off immediately after cooking.',
            savings: 'Potential savings: ‚Çπ15-40/month',
            priority: 'low'
        },
        'microwave': {
            icon: 'üì±',
            title: 'Microwave Efficiency',
            description: 'Use appropriate power levels. Cover food to reduce cooking time. Keep interior clean for optimal efficiency.',
            savings: 'Potential savings: ‚Çπ20-50/month',
            priority: 'medium'
        },
        'laptop': {
            icon: 'üíª',
            title: 'Computer/Laptop Optimization',
            description: 'Enable power-saving mode. Reduce screen brightness. Close unused applications. Use SSD drives.',
            savings: 'Potential savings: ‚Çπ30-80/month',
            priority: 'medium'
        },
        'iron': {
            icon: 'üëî',
            title: 'Electric Iron Efficiency',
            description: 'Iron multiple clothes at once. Use steam wisely. Turn off when not actively ironing.',
            savings: 'Potential savings: ‚Çπ15-35/month',
            priority: 'low'
        },
        'dishwasher': {
            icon: 'üçΩÔ∏è',
            title: 'Dishwasher Optimization',
            description: 'Run only with full loads. Use eco mode. Air dry instead of heated drying. Clean filters regularly.',
            savings: 'Potential savings: ‚Çπ100-200/month',
            priority: 'high'
        },
        'cooler': {
            icon: 'üí®',
            title: 'Air Cooler Efficiency',
            description: 'Keep water tank clean. Use in well-ventilated areas. Replace cooling pads seasonally.',
            savings: 'Potential savings: ‚Çπ50-100/month',
            priority: 'medium'
        },
        'inverter': {
            icon: 'üîã',
            title: 'Inverter/UPS Optimization',
            description: 'Maintain battery health. Use energy-efficient devices on backup. Regular maintenance required.',
            savings: 'Potential savings: ‚Çπ20-60/month',
            priority: 'low'
        },
        'router': {
            icon: 'üì∂',
            title: 'Router Efficiency',
            description: 'Use energy-efficient models. Position for optimal coverage. Schedule automatic restarts.',
            savings: 'Potential savings: ‚Çπ10-25/month',
            priority: 'low'
        },
        'mixer': {
            icon: 'ü•Ñ',
            title: 'Mixer Grinder Efficiency',
            description: 'Use appropriate jar sizes. Avoid continuous operation. Clean regularly for optimal performance.',
            savings: 'Potential savings: ‚Çπ10-30/month',
            priority: 'low'
        }
    };
    
    return detailedTips[appliance] || null;
}

// Utility functions
function getApplianceIcon(appliance) {
    const icons = {
        'bulbs': 'üí°',
        'fans': 'üåÄ',
        'ac': '‚ùÑÔ∏è',
        'refrigerator': 'üßä',
        'tv': 'üì∫',
        'washer': 'üß∫',
        'heater': 'üî•',
        'chimney': 'üè†',
        'microwave': 'üì±',
        'laptop': 'üíª',
        'iron': 'üëî',
        'dishwasher': 'üçΩÔ∏è',
        'cooler': 'üí®',
        'inverter': 'üîã',
        'router': 'üì∂',
        'mixer': 'ü•Ñ'
    };
    return icons[appliance] || 'üì¶';
}

function getApplianceName(appliance) {
    const names = {
        'bulbs': 'LED Bulbs',
        'fans': 'Ceiling Fans',
        'ac': 'Air Conditioner',
        'refrigerator': 'Refrigerator',
        'tv': 'Television',
        'washer': 'Washing Machine',
        'heater': 'Water Heater',
        'chimney': 'Kitchen Chimney',
        'microwave': 'Microwave Oven',
        'laptop': 'Laptop/Computer',
        'iron': 'Electric Iron',
        'dishwasher': 'Dishwasher',
        'cooler': 'Air Cooler',
        'inverter': 'Inverter/UPS',
        'router': 'WiFi Router',
        'mixer': 'Mixer Grinder'
    };
    return names[appliance] || appliance;
}

// Show status messages
function showStatus(message, isError) {
    const statusEl = document.getElementById('status');
    statusEl.textContent = message;
    statusEl.className = 'status-message ' + (isError ? 'error' : 'success');
    statusEl.style.display = 'block';
    
    setTimeout(() => {
        statusEl.style.display = 'none';
    }, 3000);
}
// Update database status line (used in save/load/history functions)
function updateDbStatus(message) {
  const dbStatus = document.getElementById('db-status');
  if (dbStatus) dbStatus.textContent = message;
  else console.log('DB STATUS:', message);
}


// Initialize the application
function initializeApp() {
    // 1. Set initial rate and calculate costs
    document.getElementById('location-select').value = 'chandigarh';
    updateElectricityRate();
    updateAllCosts();
    showStatus('ML Energy Predictor initialized with comprehensive appliance database!', false);

    // 2. Autotrain linear regression for immediate functionality
    setTimeout(() => {
        if (!trainedModels.linear) {
            trainModel('linear');
        }
    }, 1000);
}

// Initialize when page loads
// document.addEventListener('DOMContentLoaded', initializeApp); // Disabled in favor of window.onload logic

// DATABASE
// LocalStorage-based Database ‚Äî works in any browser

async function saveProfile() {
  const profileData = {
    appliances: {},
    location: document.getElementById('location-select').value,
    lastUpdated: Date.now()
  };

  for (const appliance of Object.keys(appliances)) {
    const qtyEl = document.getElementById(`${appliance}-qty`);
    if (qtyEl) profileData.appliances[appliance] = parseInt(qtyEl.textContent);
  }

  localStorage.setItem('energy_profile', JSON.stringify(profileData));
  showStatus('‚úÖ Profile saved successfully to LocalStorage!', false);
  updateDbStatus('Profile saved at ' + new Date().toLocaleTimeString());
}

async function loadProfile() {
  const data = localStorage.getItem('energy_profile');
  if (!data) {
    showStatus('‚ÑπÔ∏è No saved profile found in LocalStorage', false);
    updateDbStatus('No saved profile found');
    return;
  }

  const profile = JSON.parse(data);
  for (const [appliance, qty] of Object.entries(profile.appliances)) {
    const el = document.getElementById(`${appliance}-qty`);
    if (el) {
      el.textContent = qty;
      updateApplianceCost(appliance);
    }
  }

  document.getElementById('location-select').value = profile.location;
  updateElectricityRate();

  showStatus('‚úÖ Profile loaded successfully from LocalStorage!', false);
  updateDbStatus('Profile loaded from ' + new Date(profile.lastUpdated).toLocaleString());
}

//SAVE HISTORY
async function saveToHistory(historyEntry) {
  try {
    // 1Ô∏è‚É£ Save in LocalStorage (for user view)
    const history = JSON.parse(localStorage.getItem('energy_history') || '[]');
    history.unshift(historyEntry);
    if (history.length > 50) history.splice(50);
    localStorage.setItem('energy_history', JSON.stringify(history));

    console.log('‚úÖ Local history updated');

    // 2Ô∏è‚É£ Save to server (IMPORTANT)
    const res = await fetch('/api/save_history', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        appliances_json: JSON.stringify(historyEntry.appliances || {}),
        total_kwh: historyEntry.total_kwh,
        total_cost: historyEntry.total_cost,
        model_used: historyEntry.model_used
      }),
      credentials: "include"   // ‚Üê THIS FIXES RENDER + MOBILE
    });

    const data = await res.json();

    if (data.status === "ok") {
      console.log("‚úÖ Successfully saved to server DB");
    } else {
      console.warn("‚ö† Server did not save history:", data.message);
    }

  } catch (error) {
    console.error("‚ùå Error saving history:", error);
  }
}
async function saveHistory(historyEntry) {
  try {
    // 2. Backend Save (for Admin Dashboard)
    const backendRes = await fetch(`${SERVER_URL}/api/save_history`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        appliances_json: JSON.stringify(historyEntry.appliances),
        total_kwh: historyEntry.totalKwh,
        total_cost: historyEntry.totalCost,
        model_used: historyEntry.modelUsed,
      }),
      credentials: "include" // ‚≠ê REQUIRED for Render + Mobile + All devices
    });

    const backendData = await backendRes.json();

    if (backendData.status === 'ok') {
      updateDbStatus("History updated in backend database.");
      console.log("‚úÖ History also saved to backend");
    } else {
      updateDbStatus("Error saving to backend: " + backendData.message);
      console.error("‚ùå Backend save failed:", backendData.message);
    }

  } catch (error) {
    console.error('‚ùå Error saving history:', error);
    updateDbStatus('Failed to save history to server');
  }
}


// VIEW HISTORY (Modal uses LocalStorage)
async function viewHistory() {
  const history = JSON.parse(localStorage.getItem('energy_history') || '[]');
  if (history.length === 0) {
    showStatus('‚ÑπÔ∏è No history available. Calculate consumption to build history!', false);
    updateDbStatus('No local history found');
    return;
  }
  
  showHistoryModal(history);
  updateDbStatus(`Showing ${history.length} local entries`);
}

function showHistoryModal(history) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    overflow-y: auto;
    padding: 20px;
  `;

  const historyHtml = history.map(entry => {
    const date = new Date(entry.timestamp);
    // Use saved data for display consistency
    const totalKwh = entry.totalKwh || (entry.dailyConsumption || 0); 
    const monthlyCost = entry.totalCost || 0; // Use totalCost from saved entry

    return `
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea;">
        <strong>${date.toLocaleString()}</strong><br>
        <span style="color:#666;">
          ‚ö° Daily: ${totalKwh.toFixed(2)} kWh | 
          üí∞ Monthly Cost: ‚Çπ${monthlyCost.toFixed(2)} 
        </span><br>
        <span style="font-size:0.85rem; color:#999;">
          Location: ${entry.location || 'N/A'} | Model: ${entry.modelUsed || 'N/A'}
        </span>
      </div>
    `;
  }).join('');

  modal.innerHTML = `
    <div style="background:white; border-radius:15px; padding:30px; max-width:700px; width:100%; max-height:80vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <h2 style="color:#333; margin-bottom:20px;">üìä Local Consumption History</h2>
      <p style="color:#666; margin-bottom:20px;">Showing ${history.length} entries stored in your browser.</p>
      <div>${historyHtml || '<p style="text-align:center; color:#999;">No history found.</p>'}</div>
      <button onclick="this.parentElement.parentElement.remove()" 
        style="width:100%; padding:12px; margin-top:20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:1rem;">
        Close
      </button>
    </div>
  `;

  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
  document.body.appendChild(modal);
}

async function clearAllData() {
  if (!window.confirm('Clear ALL data (local profile + local history)?')) return;
  localStorage.removeItem('energy_profile');
  localStorage.removeItem('energy_history');
  showStatus('‚úÖ All local data cleared successfully!', false);
  updateDbStatus('All local data cleared');
}
// ----------------------------
// BACKEND AUTH FUNCTIONS
// ----------------------------

// Check session on page load
window.onload = async function() {
    // Initialize app settings
    initializeApp(); 
    
    // Check authentication status
    // FIX: Use absolute URL
    const res = await fetch(`${SERVER_URL}/me`);
    const data = await res.json();
    
    const appSection = document.getElementById("app-section");
    const historyBtn = document.getElementById("view-history-btn"); 
    
    if (data.logged_in) {
        // If logged in, ensure app is visible
        appSection.style.display = "block";

        // RESTRICTION FIX: Only show the button if the user is an admin
        if (data.role === 'admin') {
             historyBtn.style.display = 'block';
        } else {
             historyBtn.style.display = 'none';
        }
        
    } else {
        // If NOT logged in, redirect to login page
        window.location.href = "login.html";
    }
}
// DARK MODE LOGIC
const darkToggle = document.getElementById("darkModeToggle");

// Load saved mode
if (localStorage.getItem("darkMode") === "enabled") {
    document.body.classList.add("dark-mode");
    darkToggle.textContent = "‚òÄÔ∏è Light Mode";
}

darkToggle.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");

    if (document.body.classList.contains("dark-mode")) {
        darkToggle.textContent = "‚òÄÔ∏è Light Mode";
        localStorage.setItem("darkMode", "enabled");
    } else {
        darkToggle.textContent = "üåô Dark Mode";
        localStorage.setItem("darkMode", "disabled");
    }
});

</script>
</div> 
</body>
</html>